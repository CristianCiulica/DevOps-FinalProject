<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Market Dashboard Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f0f2f5; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: none; }
        .price-up { color: #28a745; }
        .price-anomaly { color: #dc3545; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }
        #chartContainer { height: 400px; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card p-4">
                <div class="text-center mb-4">
                    <h3>ðŸ“ˆ Market Data Live</h3>
                    <h1 id="currentPriceHeader" class="display-4 price-up">Awaiting Data...</h1>
                </div>

                <div id="chartContainer">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var stompClient = null;
    var myChart = null;

    // --- Configurare Grafic ---
    function initChart() {
        const ctx = document.getElementById('priceChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Aici vom pune orele (ex: 17:30:01)
                datasets: [{
                    label: 'BTC-USD Price ($)',
                    data: [], // Aici vom pune preÈ›urile
                    borderColor: '#28a745', // Linie verde
                    backgroundColor: 'rgba(40, 167, 69, 0.1)', // Umplere uÈ™oarÄƒ sub linie
                    borderWidth: 2,
                    pointRadius: 3,
                    fill: true,
                    tension: 0.3 // Face linia puÈ›in curbatÄƒ
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: true },
                    y: {
                        display: true,
                        // Putem ajusta axa Y sÄƒ Ã®nceapÄƒ de la un minim realist dacÄƒ vrem
                        // min: 89000
                    }
                },
                animation: {
                    duration: 0 // DezactivÄƒm animaÈ›ia lungÄƒ la fiecare update pentru performanÈ›Äƒ
                }
            }
        });
    }

    // --- Configurare WebSocket ---
    function connect() {
        var socket = new SockJS('/ws-market');
        stompClient = Stomp.over(socket);
        // stompClient.debug = null; // DecomenteazÄƒ ca sÄƒ ascunzi logurile din consolÄƒ

        stompClient.connect({}, function (frame) {
            console.log('âœ… Conectat la WebSocket: ' + frame);
            // Ne abonÄƒm la canalul /topic/prices
            stompClient.subscribe('/topic/prices', function (messageOutput) {
                handleNewPrice(JSON.parse(messageOutput.body));
            });
        });
    }

    // Functia care ruleazÄƒ cÃ¢nd vine un preÈ› nou
    function handleNewPrice(data) {
        const priceHeader = document.getElementById('currentPriceHeader');
        const timestamp = new Date().toLocaleTimeString();

        // 1. ActualizÄƒm Titlul Mare
        priceHeader.innerText = `BTC: $${data.price.toFixed(2)}`;

        if (data.anomaly) {
            priceHeader.className = 'display-4 price-anomaly';
        } else {
            priceHeader.className = 'display-4 price-up';
        }

        // 2. AdÄƒugÄƒm date Ã®n Grafic
        addDataToChart(timestamp, data.price);
    }

    function addDataToChart(label, data) {
        // AdÄƒugÄƒm timpul È™i preÈ›ul Ã®n array-urile graficului
        myChart.data.labels.push(label);
        myChart.data.datasets.forEach((dataset) => {
            dataset.data.push(data);
        });

        // PÄƒstrÄƒm doar ultimele 30 de puncte pentru a nu aglomera graficul
        if (myChart.data.labels.length > 30) {
            myChart.data.labels.shift(); // Scoate primul element (cel mai vechi)
            myChart.data.datasets.forEach((dataset) => {
                dataset.data.shift();
            });
        }

        // RedesenÄƒm graficul cu noile date
        myChart.update();
    }

    // Pornim totul cÃ¢nd se Ã®ncarcÄƒ pagina
    window.onload = function() {
        initChart();
        connect();
    };
</script>

</body>
</html>